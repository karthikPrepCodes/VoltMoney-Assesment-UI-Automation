pipeline {
  agent any

  tools {
    nodejs "node18" // make sure this name matches your NodeJS tool in Jenkins -> Global Tool Configuration
  }

  environment {
    PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD = "0"
  }

  stages {
    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    // change into the subfolder where your Playwright package.json lives
    stage('Install dependencies (project)') {
      steps {
        dir('voltMoney-playwright-automation') {
          script {
            if (fileExists('package-lock.json') || fileExists('package.json')) {
              // prefer npm ci when lockfile present; fallback to npm install
              if (fileExists('package-lock.json')) {
                sh 'npm ci --no-audit --no-fund'
              } else {
                sh 'npm install --no-audit --no-fund'
              }
            } else {
              error "package.json not found in voltMoney-playwright-automation â€” ensure tests repo has package.json"
            }
          }
        }
      }
    }

    stage('Install Playwright browsers') {
      steps {
        dir('voltMoney-playwright-automation') {
          sh 'npx playwright install --with-deps'
        }
      }
    }

    stage('Run Playwright Tests') {
      steps {
        dir('voltMoney-playwright-automation') {
          // run playwright tests; adjust flags/projects as needed
          sh 'npx playwright test --reporter=html'
        }
      }
    }

    stage('Archive & Publish Report') {
      steps {
        dir('voltMoney-playwright-automation') {
          archiveArtifacts artifacts: 'playwright-report/**', allowEmptyArchive: false
          publishHTML(target: [
            reportDir: 'playwright-report',
            reportFiles: 'index.html',
            reportName: 'Playwright HTML Report',
            keepAll: true
          ])
        }
      }
    }
  }

  post {
    success { echo "Playwright tests finished SUCCESS" }
    failure { echo "Playwright tests FAILED" }
    always {
      echo "Build finished at $(date)"
    }
  }
}
