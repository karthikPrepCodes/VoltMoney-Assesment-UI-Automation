pipeline {
  agent any

  tools {
    nodejs "node18" // ensure this matches your NodeJS tool name in Jenkins
  }

  environment {
    PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD = "0"
  }

  stages {
    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Install dependencies (project)') {
      steps {
        dir('voltMoney-playwright-automation') {
          script {
            if (fileExists('package-lock.json') || fileExists('package.json')) {
              if (fileExists('package-lock.json')) {
                sh 'npm ci --no-audit --no-fund'
              } else {
                sh 'npm install --no-audit --no-fund'
              }
            } else {
              error "package.json not found in voltMoney-playwright-automation â€” ensure tests repo has package.json"
            }
          }
        }
      }
    }

    stage('Install Playwright browsers') {
      steps {
        dir('voltMoney-playwright-automation') {
          sh 'npx playwright install --with-deps'
        }
      }
    }

    stage('Run Playwright Tests') {
      steps {
        dir('voltMoney-playwright-automation') {
          sh 'npx playwright test --reporter=html'
        }
      }
    }

    stage('Archive & Publish Report') {
      steps {
        dir('voltMoney-playwright-automation') {
          archiveArtifacts artifacts: 'playwright-report/**', allowEmptyArchive: false
          publishHTML(target: [
            reportDir: 'playwright-report',
            reportFiles: 'index.html',
            reportName: 'Playwright HTML Report',
            keepAll: true
          ])
        }
      }
    }
  }

  post {
    success {
      echo "Playwright tests finished SUCCESS"
    }
    failure {
      echo "Playwright tests FAILED"
    }
    always {
      // use sh for shell substitution so Groovy doesn't try to parse $
      sh 'echo Build finished at $(date)'
    }
  }
}
